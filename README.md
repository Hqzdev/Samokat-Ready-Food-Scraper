# Скрейпер готовой еды ВкусВилл

Оптимизированный Python-парсер для сбора готовой еды с ВкусВилл с поддержкой адресов и максимальным извлечением БЖУ.

## Особенности

- **Геолокация**: Поддержка адресов в текстовом формате и координат
- **Антибот-защита**: Ротация заголовков, повторы с экспоненциальной паузой, rate-limiting
- **Дедупликация**: Автоматическое удаление дубликатов по (shop, id)
- **Валидация**: Проверка качества данных и заполненности БЖУ
- **Экспорт**: CSV (UTF-8, ; как разделитель) и JSONL
- **Чекпоинты**: Возможность продолжения с места остановки

## Установка

```bash
# Клонирование репозитория
git clone <repository-url>
cd Samokat-Ready-Food-Scraper

# Установка зависимостей
pip install -r requirements.txt
```

## Использование

### Основные команды

```bash
# Быстрый оптимизированный парсинг (рекомендуется)
python3 main.py --shop vkusvill_optimized --address "Москва, Красная площадь, 1" --limit 400 --out data/moscow.csv

# Интерактивный режим с выбором адреса
python3 main.py --shop vkusvill_optimized --limit 400 --out data/products.csv

# Максимальное качество БЖУ
python3 main.py --shop vkusvill_bju_only --address "Санкт-Петербург, Невский проспект, 1" --limit 500 --out data/spb_quality.csv

# Быстрый тест
python3 fast_test.py "Москва, Тверская улица, 10" 200
```

### Режимы парсинга

- `vkusvill_optimized` - **Быстрый оптимизированный** (рекомендуется)
- `vkusvill_bju_only` - Только товары с полным БЖУ
- `vkusvill_full` - Максимальное извлечение данных
- `vkusvill_fast` - Быстрый режим
- `vkusvill` - Обычный режим

### Параметры

- `--shop`: Режим парсинга (по умолчанию vkusvill_optimized)
- `--address`: Адрес в текстовом формате
- `--city`: Город (по умолчанию Москва)
- `--coords`: Координаты "широта,долгота"
- `--limit`: Количество товаров (по умолчанию 400)
- `--out`: Путь к CSV файлу
- `--concurrency`: Одновременных задач (по умолчанию 10)
- `--timeout`: Таймаут запросов (по умолчанию 30)
- `--verbose`: Подробное логирование

## Работа с геолокацией

### Поддерживаемые форматы адресов

```bash
# Полный адрес
python main.py --shop vkusvill --address "Москва, Красная площадь, 1" --out data/moscow.csv

# Город и улица
python main.py --shop vkusvill --address "Санкт-Петербург, Невский проспект" --out data/spb.csv

# Только город
python main.py --shop vkusvill --address "Екатеринбург" --out data/ekb.csv

# Координаты
python main.py --shop vkusvill --coords "55.7558,37.6176" --out data/coords.csv
```

### Тестирование геолокации

```bash
# Тест сервиса геолокации
python location_service.py

# Быстрый тест парсера
python quick.py

# Анализ результатов
python check_results.py data/your_file.csv
```

### Поддерживаемые города

- ✅ **Москва** - полная поддержка ВкусВилл
- ✅ **Санкт-Петербург** - полная поддержка ВкусВилл  
- ✅ **Екатеринбург** - полная поддержка ВкусВилл
- ⚠️ **Другие города** - ограниченная поддержка

## Формат данных

Выгружаемые поля (в порядке):

| Поле | Описание | Тип |
|------|----------|-----|
| id | Стабильный ID товара | string |
| name | Название товара | string |
| category | Категория (хлебные крошки) | string |
| kcal_100g | Калории на 100г | float |
| protein_100g | Белки на 100г | float |
| fat_100g | Жиры на 100г | float |
| carb_100g | Углеводы на 100г | float |
| portion_g | Масса порции в граммах | float |
| price | Цена в рублях | float |
| shop | Магазин (vkusvill/samokat/lavka) | string |
| tags | Теги через ; | string |
| composition | Состав | string |
| url | Ссылка на карточку | string |
| photo | URL фото | string |

## Стратегия достижения 500+ позиций

### ВкусВилл (основной источник)
- Обход всех подкатегорий "Готовой еды"
- Включает: вторые блюда, салаты, супы, диетические блюда, новинки
- Стабильно дает 500+ позиций за проход

### Самокат
- SPA-интерфейс с геозависимостью
- Требует установки города/координат
- Возможны ограничения без JS-рендеринга

### Лавка
- Агрессивная антибот-защита (SmartCaptcha)
- Бережный режим: редкие запросы, высокий таймаут
- Ограниченный объем без headless браузера

## Логирование

Все операции логируются в файл `scraper.log` и консоль:
- Успешные запросы
- Ошибки и предупреждения
- Статистика сбора
- Проблемы с валидацией

## Примеры вывода

```bash
============================================================
СКРЕЙПИНГ ЗАВЕРШЕН
============================================================
Всего товаров: 523
С заполненным БЖУ-100г: 487
Без БЖУ-100г: 36
Дубликатов: 12
Невалидных: 8
Доля с БЖУ: 93.1%

Топ-категории:
  Вторые блюда: 156
  Салаты: 89
  Супы: 67
  Диетические блюда: 45
  Новинки: 38
============================================================
```

## Устранение проблем

### Блокировка запросов
- Уменьшите `--concurrency` до 2-4
- Используйте `--proxy` для ротации IP
- Увеличьте `--timeout` до 60

### Мало товаров (< 300)
- Проверьте доступность сайта
- Убедитесь в корректности города
- Попробуйте другой магазин

### Ошибки парсинга
- Включите `--verbose` для детального логирования
- Проверьте изменения в структуре сайтов
- Обновите селекторы в скрейперах

## Лицензия

MIT License

